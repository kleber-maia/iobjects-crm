   
package imanager.card;

import java.sql.*;
import java.util.*;

import iobjects.*;
import iobjects.card.*;
import iobjects.help.*;
import iobjects.util.*;

import imanager.misc.*;

/**
 * Representa o cartão de Atendimento Assunto.
 */ 
public class CartaoCampanhaVendas extends Card {

  // identificação da classe
  static public final String CLASS_NAME = "imanager.card.CartaoCampanhaVendas";
  // nossa ajuda extra
  static public final String HELP = "";
  // nossas ações
  static public final Action ACTION = new Action("cartaoCampanhaVendas", "Vendas Com/Sem Campanha", "Exibe os últimos 30 dias de vendas informando se está em período de campanha ou não.", HELP, "card/cartaocampanhavendas.jsp", "CRM", "", Action.CATEGORY_CARD, false, false);

  /**
   * Construtor padrão.
   */
  public CartaoCampanhaVendas() {
    // nossas ações
    actionList().add(ACTION);
  }

  /**
   * Retorna o ResultSet contendo os valores das vendas realizadas 
   * no período de 1 mês e informa se houve campanha nesse periodo.
   * <ol>
   *   <li>valor
   *   <li>data
   *   <li>campanha
   * </ol>
   * <b>Importante: a rotina que executar este método deve ser responsável por
   * fechar o ResultSet retornardo e o seu Statement.</b>
   * @return ResultSet Retorna o ResultSet contendo os Assuntos e as
   *         quantidades de Atendimentos no mês.
   * @throws Exception Em caso de exceção na tentativa de acesso ao banco de
   *                   dados.
   */
  public ResultSet getResultSetCampanhaVendas(int empresaId) throws Exception {
    // inicia transação
    getFacade().beginTransaction();
    try {
      // SQL
      String sql = "SELECT SUM(faturamento_saida.do_valor_total) as valor, CAST(faturamento_saida.dt_faturamento as DATE) as data, crm_campanha.va_nome as campanha "
                 + " FROM faturamento_saida "
                 + " LEFT JOIN crm_campanha ON (faturamento_saida.dt_faturamento >= crm_campanha.da_inicio AND CAST(faturamento_saida.dt_faturamento as DATE) <= crm_campanha.da_termino) "
                 + " WHERE  "
                 + " faturamento_saida.in_empresa_id = ? AND "
                 + " (faturamento_saida.dt_faturamento >= ? AND faturamento_saida.dt_faturamento < ?) AND "
                 + " faturamento_saida.sm_status = " + StatusSaida.FATURADA
                 + " GROUP BY data, campanha "
                 + " ORDER BY data";
      // prepara a query
      PreparedStatement preparedStatement = prepare(sql);
      // preenche os parâmetros
      preparedStatement.setInt(1, empresaId);
      preparedStatement.setTimestamp(2, new Timestamp(DateTools.getCalculatedMonths(DateTools.getActualDate(), -1).getTime()));
      preparedStatement.setTimestamp(3, new Timestamp(DateTools.getCalculatedDays(DateTools.getActualDate(), 1).getTime())); 
      // executa
      preparedStatement.execute();
      // salva tudo
      getFacade().commitTransaction();
      // retorna
      return preparedStatement.getResultSet();
    }
    catch (Exception e) {
      // desfaz tudo
      getFacade().rollbackTransaction();
      throw e;
    } // try-catch
  }

}
